{% extends "index.html" %} 
{% load static %} 
{% load humanize %} 

{% block title%} Invoices {% endblock %} 

{% block breadcrumbs %}
  <h3>Finance Portal</h3>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
      <li class="breadcrumb-item"><a href="{% url 'transactions' %}">Transactions</a></li>
      <li class="breadcrumb-item active" aria-current="page">Invoices</li>
      <li class="breadcrumb-item"><a href="{% url 'mileage_log' %}">Mileage Log</a></li>
      <li class="breadcrumb-item"><a href="{% url 'category_page' %}">Categories</a></li>
      <li class="breadcrumb-item"><a href="{% url 'reports' %}">Financial Reports</a></li>
    </ol>
  </nav>
{% endblock %}

{% block content %}
<div class="container bg-light border rounded p-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
    <h2 class="text-primary mb-3 mb-md-0">Invoices</h2>
    <form method="get" class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto">
      <div class="input-group">
        <input type="text" name="search" class="form-control" placeholder="Search invoices..." value="{{ search_query }}">
        <button type="submit" class="btn btn-outline-secondary">
          <i class="fa-solid fa-magnifying-glass-dollar"></i>
        </button>
      </div>
    </form>
  </div>

  <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
    <a href="{% url 'create_invoice' %}" class="btn btn-outline-primary">
      <i class="fas fa-plus"></i> New Invoice
    </a>
    <a href="{% url 'export_invoices_csv' %}?search={{ search_query }}&sort={{ current_sort }}&direction={{ current_direction }}" class="btn btn-outline-success">
      <i class="fa-solid fa-file-csv"></i> CSV
    </a>
    <a href="{% url 'export_invoices_pdf' %}?search={{ search_query }}&sort={{ current_sort }}&direction={{ current_direction }}" class="btn btn-outline-danger">
      <i class="fa-solid fa-file-pdf"></i> PDF
    </a>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-primary text-center">
        <tr>
          <th>Invoice #</th>
          <th>Client</th>
          <th>Location</th>
          <th>Service</th>
          <th>Amount</th>
          <th>Date</th>
          <th>Due</th>
          <th>Paid</th>
          <th>Days</th>
          <th>
            <span data-bs-toggle="tooltip" data-bs-placement="top" title="View, edit, delete, review, or email this invoice.">
              Actions <i class="fa-solid fa-circle-info text-secondary ms-1"></i>
            </span>
          </th>
        </tr>
      </thead>

      <tbody>
        {% for invoice in invoices %}
        <tr class="text-center">
          <td>{{ invoice.invoice_numb }}</td>
          <td>{{ invoice.client }}</td>
          <td>{{ invoice.keyword }}</td>
          <td>{{ invoice.service }}</td>
          <td>${{ invoice.amount|floatformat:2|intcomma }}</td>
          <td>{{ invoice.date }}</td>
          <td>{{ invoice.due }}</td>
          <td>
            <span class="badge {% if invoice.paid_date %}bg-success{% else %}bg-danger{% endif %}">
              {% if invoice.paid_date %}{{ invoice.paid_date|date:"m-d-y" }}{% else %}No{% endif %}
            </span>
          </td>
          <td>{% if invoice.paid_date %}{{ invoice.days_to_pay }} days{% else %}<span class="text-muted">â€”</span>{% endif %}</td>
          <td class="text-nowrap">
            <a href="{% url 'invoice_detail' invoice.pk %}" class="text-decoration-none me-2"><i class="fa-solid fa-eye text-primary"></i></a>
            <a href="{% url 'update_invoice' invoice.pk %}" class="text-decoration-none me-2"><i class="fa-solid fa-pencil text-primary"></i></a>
            <a href="{% url 'invoice_review' invoice.pk %}" class="text-decoration-none me-2"><i class="fa-regular fa-file text-primary"></i></a>
            <a href="{% url 'invoice_delete' invoice.pk %}" class="text-decoration-none me-2"><i class="fa-solid fa-trash-can text-primary"></i></a>
            <a href="#" class="send-email text-decoration-none" data-invoice-id="{{ invoice.id }}">
              <i class="fa-regular fa-paper-plane text-primary"></i>
              <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center text-muted">No invoices found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </